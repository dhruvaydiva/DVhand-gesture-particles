<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Gesture Particle System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { overflow: hidden; font-family: Arial, sans-serif; background: #000; }
        #container { width: 100vw; height: 100vh; }
        #video { position: absolute; top: 10px; right: 10px; width: 160px; height: 120px;
                 border: 2px solid #0ff; border-radius: 8px; transform: scaleX(-1);
                 z-index: 10; opacity: 0.7; }
        #info { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8);
                color: white; padding: 15px; border-radius: 8px; font-size: 14px;
                max-width: 300px; z-index: 10; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
                   background: rgba(0,0,0,0.9); color: white; padding: 30px;
                   border-radius: 12px; text-align: center; z-index: 100; }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white;
                   border-radius: 50%; width: 40px; height: 40px;
                   animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #hint { position: absolute; bottom: 10px; left: 10px; background: rgba(0,100,200,0.8);
                color: white; padding: 10px 15px; border-radius: 8px; font-size: 18px;
                font-weight: bold; z-index: 10; }
        #instructions { position: absolute; bottom: 10px; right: 10px;
                        background: rgba(0,0,0,0.8); color: white; padding: 12px;
                        border-radius: 8px; font-size: 12px; max-width: 250px; z-index: 10; }
    </style>
</head>
<body>
    <div id="container"></div>
    <video id="video" autoplay playsinline></video>
    
    <div id="loading">
        <div class="spinner"></div>
        <p>Initializing Hand Tracking...</p>
        <p style="font-size: 12px; margin-top: 10px;">Please allow camera access</p>
    </div>

    <div id="info">
        <strong>Hand Gesture Control</strong><br>
        <span id="status">Starting...</span><br>
        <span id="template">Template: sphere</span><br>
        <span id="gesture">Gesture: None</span>
    </div>

    <div id="hint">Show your hand</div>
    <div id="instructions">
        <strong>Gestures:</strong><br>
        ‚úä Fist - Change shape<br>
        ‚úåÔ∏è Peace - Expand<br>
        üñêÔ∏è Open - Contract<br>
        üëç Thumbs Up - Speed up<br>
        üëá Point Down - Slow down
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script>
        var scene, camera, renderer, particles, geometry, material;
        var count = 4000;
        var targets = [];
        var positions = [];
        var hue = 0;
        var scale = 1;
        var speed = 0.001;
        var index = 0;
        var lastTime = 0;
        var names = ['sphere', 'heart', 'flower', 'saturn', 'fireworks', 'cube', 'helix', 'spiral', 'wave'];

        function makeSphere() {
            var arr = [];
            for (var i = 0; i < count; i++) {
                var theta = Math.random() * Math.PI * 2;
                var phi = Math.acos(Math.random() * 2 - 1);
                var r = 2 + Math.random() * 0.5;
                arr.push(r * Math.sin(phi) * Math.cos(theta));
                arr.push(r * Math.sin(phi) * Math.sin(theta));
                arr.push(r * Math.cos(phi));
            }
            return arr;
        }

        function makeHeart() {
            var arr = [];
            for (var i = 0; i < count; i++) {
                var t = (i / count) * Math.PI * 2;
                var u = Math.random() * 2 - 1;
                var st = Math.sin(t);
                var ct = Math.cos(t);
                var x = 16 * st * st * st * 0.15;
                var y = (13 * ct - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t)) * 0.15;
                arr.push(x);
                arr.push(y);
                arr.push(u * 0.5);
            }
            return arr;
        }

        function makeFlower() {
            var arr = [];
            var petals = 8;
            for (var i = 0; i < count; i++) {
                var angle = (i / count) * Math.PI * 2 * petals;
                var r = Math.sin(petals * angle) * 2 + 2.5;
                var theta = (i / count) * Math.PI * 2;
                arr.push(r * Math.cos(theta));
                arr.push(r * Math.sin(theta));
                arr.push(Math.random() * 0.5 - 0.25);
            }
            return arr;
        }

        function makeSaturn() {
            var arr = [];
            var ringCount = Math.floor(count * 0.6);
            for (var i = 0; i < ringCount; i++) {
                var angle = Math.random() * Math.PI * 2;
                var r = 2 + Math.random() * 1.5;
                arr.push(r * Math.cos(angle));
                arr.push((Math.random() - 0.5) * 0.15);
                arr.push(r * Math.sin(angle));
            }
            for (var i = ringCount; i < count; i++) {
                var theta = Math.random() * Math.PI * 2;
                var phi = Math.acos(Math.random() * 2 - 1);
                var r = 1 + Math.random() * 0.4;
                arr.push(r * Math.sin(phi) * Math.cos(theta));
                arr.push(r * Math.sin(phi) * Math.sin(theta));
                arr.push(r * Math.cos(phi));
            }
            return arr;
        }

        function makeFireworks() {
            var arr = [];
            var bursts = 6;
            for (var b = 0; b < bursts; b++) {
                var cx = (Math.random() - 0.5) * 5;
                var cy = (Math.random() - 0.5) * 5;
                var cz = (Math.random() - 0.5) * 5;
                for (var i = 0; i < count / bursts; i++) {
                    var theta = Math.random() * Math.PI * 2;
                    var phi = Math.acos(Math.random() * 2 - 1);
                    var r = Math.random() * 1.5;
                    arr.push(cx + r * Math.sin(phi) * Math.cos(theta));
                    arr.push(cy + r * Math.sin(phi) * Math.sin(theta));
                    arr.push(cz + r * Math.cos(phi));
                }
            }
            return arr;
        }

        function makeCube() {
            var arr = [];
            for (var i = 0; i < count; i++) {
                arr.push((Math.random() - 0.5) * 3);
                arr.push((Math.random() - 0.5) * 3);
                arr.push((Math.random() - 0.5) * 3);
            }
            return arr;
        }

        function makeHelix() {
            var arr = [];
            for (var i = 0; i < count; i++) {
                var t = (i / count) * Math.PI * 10;
                arr.push(1.5 * Math.cos(t));
                arr.push(t * 0.4 - 4);
                arr.push(1.5 * Math.sin(t));
            }
            return arr;
        }

        function makeSpiral() {
            var arr = [];
            for (var i = 0; i < count; i++) {
                var t = (i / count) * Math.PI * 12;
                var r = t * 0.2;
                arr.push(r * Math.cos(t));
                arr.push(r * Math.sin(t));
                arr.push(t * 0.3 - 3);
            }
            return arr;
        }

        function makeWave() {
            var arr = [];
            var grid = Math.floor(Math.sqrt(count));
            for (var i = 0; i < count; i++) {
                var x = (i % grid) / grid * 6 - 3;
                var z = Math.floor(i / grid) / grid * 6 - 3;
                var y = Math.sin(x * 2) * Math.cos(z * 2) * 0.8;
                arr.push(x);
                arr.push(y);
                arr.push(z);
            }
            return arr;
        }

        var templates = [makeSphere, makeHeart, makeFlower, makeSaturn, makeFireworks, makeCube, makeHelix, makeSpiral, makeWave];

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000510);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 8;
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('container').appendChild(renderer.domElement);

            geometry = new THREE.BufferGeometry();
            var initial = makeSphere();
            positions = new Float32Array(initial);
            targets = initial.slice();
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

            var colors = new Float32Array(count * 3);
            for (var i = 0; i < count; i++) {
                var c = new THREE.Color().setHSL(Math.random(), 1, 0.6);
                colors[i * 3] = c.r;
                colors[i * 3 + 1] = c.g;
                colors[i * 3 + 2] = c.b;
            }
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            material = new THREE.PointsMaterial({
                size: 0.05,
                vertexColors: true,
                transparent: true,
                opacity: 0.9,
                blending: THREE.AdditiveBlending
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);
            window.addEventListener('resize', resize);
        }

        function resize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function change(name) {
            targets = templates[index]();
            document.getElementById('template').textContent = 'Template: ' + names[index];
        }

        function detect(marks) {
            var thumb = marks[4];
            var idx = marks[8];
            var mid = marks[12];
            var ring = marks[16];
            var pink = marks[20];
            var wrist = marks[0];

            var tUp = thumb.y < marks[3].y;
            var iUp = idx.y < marks[6].y;
            var mUp = mid.y < marks[10].y;
            var rUp = ring.y < marks[14].y;
            var pUp = pink.y < marks[18].y;

            if (!iUp && !mUp && !rUp && !pUp) return 'fist';
            if (iUp && mUp && !rUp && !pUp) return 'peace';
            if (iUp && mUp && rUp && pUp) return 'open';
            if (tUp && !iUp && !mUp && !rUp && !pUp) return 'thumbup';
            if (iUp && !mUp && !rUp && !pUp && idx.y > wrist.y) return 'pointdown';
            return 'none';
        }

        function handle(gest, marks) {
            var now = Date.now();
            document.getElementById('gesture').textContent = 'Gesture: ' + gest;
            document.getElementById('hint').textContent = gest.toUpperCase();

            if (now - lastTime < 1000) return;

            if (gest === 'fist') {
                index = (index + 1) % templates.length;
                change();
                lastTime = now;
            } else if (gest === 'peace') {
                scale = Math.min(scale + 0.3, 2.5);
            } else if (gest === 'open') {
                scale = Math.max(scale - 0.3, 0.5);
            } else if (gest === 'thumbup') {
                speed = Math.min(speed + 0.002, 0.01);
            } else if (gest === 'pointdown') {
                speed = Math.max(speed - 0.002, 0.0001);
            }

            if (marks) hue = marks[9].x * 360;
        }

        function update() {
            var pos = geometry.attributes.position.array;
            var col = geometry.attributes.color.array;

            for (var i = 0; i < count; i++) {
                var i3 = i * 3;
                pos[i3] += (targets[i3] * scale - pos[i3]) * 0.05;
                pos[i3 + 1] += (targets[i3 + 1] * scale - pos[i3 + 1]) * 0.05;
                pos[i3 + 2] += (targets[i3 + 2] * scale - pos[i3 + 2]) * 0.05;

                var h = (hue + i * 0.1) % 360;
                var c = new THREE.Color().setHSL(h / 360, 1, 0.6);
                col[i3] = c.r;
                col[i3 + 1] = c.g;
                col[i3 + 2] = c.b;
            }

            geometry.attributes.position.needsUpdate = true;
            geometry.attributes.color.needsUpdate = true;
            particles.rotation.y += speed;
            particles.rotation.x += speed * 0.5;
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }

        function startCam() {
            var vid = document.getElementById('video');
            var hands = new Hands({
                locateFile: function(file) {
                    return 'https://cdn.jsdelivr.net/npm/@mediapipe/hands/' + file;
                }
            });

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults(function(res) {
                if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                    var marks = res.multiHandLandmarks[0];
                    var gest = detect(marks);
                    handle(gest, marks);
                    document.getElementById('status').textContent = 'Hand detected ‚úì';
                } else {
                    document.getElementById('gesture').textContent = 'Gesture: None';
                    document.getElementById('hint').textContent = 'Show your hand';
                    document.getElementById('status').textContent = 'No hand detected';
                }
            });

            var cam = new Camera(vid, {
                onFrame: async function() {
                    await hands.send({image: vid});
                },
                width: 640,
                height: 480
            });
            
            cam.start().then(function() {
                document.getElementById('loading').style.display = 'none';
            });
        }

        init();
        animate();
        startCam();
    </script>
</body>
</html>
